apiVersion: v1
kind: Secret
metadata:
  name: {{ include "cos-common.fullname" (dict "root" . "name" "" "values" .Values.main) | trim }}
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: {{ .Chart.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    helm.sh/chart: {{ printf "%s-%s" .Chart.Name (replace "+" "_" .Chart.Version) }}
type: Opaque
data:
  {{- range $key, $value := .Values.apache.secretEnvs }}
  apache-{{ $key | replace "/" "-" }}: {{ $value | b64enc | quote }}
  {{- end }}
  {{- range $key, $value := .Values.apache.secretFiles }}
  apache-{{ $key | replace "/" "-" }}: {{ $value | b64enc | quote }}
  {{- end }}

  {{- range $key, $value := .Values.jetty.secretEnvs }}
  jetty-{{ $key | replace "/" "-" }}: {{ $value | b64enc | quote }}
  {{- end }}
  {{- range $key, $value := .Values.jetty.secretFiles }}
  jetty-{{ $key | replace "/" "-" }}: {{ $value | b64enc | quote }}
  {{- end }}
  
  {{- if .Values.tls.enabled }}
  {{- /* Inject TLS certs from any enabled tls.<app> block so cos-common mounts match subPaths. */ -}}
  {{- range $app, $cfg := omit .Values.tls "enabled" }}
    {{- if and $cfg (kindIs "map" $cfg) (default false $cfg.enabled) }}
      {{- range $key, $value := (default dict $cfg.files) }}
  certs-{{ $app }}-{{ $key }}: {{ $value | b64enc | quote }}
      {{- end }}
      {{- range $key, $value := (default dict $cfg.base64Files) }}
  certs-{{ $app }}-{{ $key }}: {{ $value | nospace | quote }}
      {{- end }}
    {{- end }}
  {{- end }}
  {{- end }}
