### ------- Global or Reusable parts across values.yaml -------
appImage:
  repository: quay.io/centerforopenscience/osf-gravyvalet
  tag: develop
  pullPolicy: Always

nginx:
  workerCount: 1
  resources: {}
  proxySourceRanges: []
  realIpHeader: X-Real-IP
  realIpRecursive: "off"
  vts:
    enabled: false
    internalPort: 18080
    statusZoneSize: 10m
    defaultFilterKey: "$geoip_country_code country::*"

# TLS client certificate scaffold (disabled by default)
# override-values.yaml
tls:
  enabled: false
  postgresql:
    enabled: false
    mountPath: /var/www/.postgresql
    files:
      # Root Certificate
      root.crt: |-
        
      # Root Certificate Revocation List
      root.crl: |-
        
      # Database key
      postgresql.key: |-
        
      # Database certificate
      postgresql.crt: |-

  rabbitmq:
    enabled: false
    mountPath: /var/www/.rabbitmq
    files:
      worker.key: |-
        
      worker.pem: |-
        
      ca-chain.cert.pem: |-


## Remember that full name for all objects is '{{ include "cos-common.fullname" (dict "root" . "name" "") | trim }}'
## or in other form current naming is Release.Name-Chart.Name

## =============== MAIN Component ===============
main:
  enabled: true

  component: main

  replicas: 1

  http:
    containers:
      nginx:
        internalPort: 80
        externalPort: 8000
        serviceType: ClusterIP

# ------- Configuration follows for containerName: nginx -------
  image:
    repository: quay.io/centerforopenscience/nginx
    tag: latest
    pullPolicy: Always

  containerName: nginx

  command:
    - nginx
    - -c
    - /etc/nginx/nginx.conf
    - -g
    - daemon off;

  env: []

  envFrom: []

  probes:
    readiness:
      httpGet:
        path: /healthz
        port: "{{ .Values.main.http.containers.nginx.internalPort }}"
      initialDelaySeconds: 10

  ports:
    - name: http-internal
      containerPort: "{{ .Values.main.http.containers.nginx.internalPort }}"
      protocol: TCP

  volumeMounts:
    - name: static
      mountPath: /static
      readOnly: true
    - name: config
      mountPath: /etc/nginx/nginx.conf
      subPath: nginx.conf
      readOnly: true
    - name: config
      mountPath: /usr/share/nginx/html/robots.txt
      subPath: robots.txt
      readOnly: true

  additionalVolumeMounts: []

  resources: {}

# ------- Init containers -------
  initContainers:
    - name: collectstatic
      image: "{{ .Values.appImage.repository }}:{{ .Values.appImage.tag }}"
      imagePullPolicy: "{{ .Values.appImage.pullPolicy }}"
      command:
        - python
        - manage.py
        - collectstatic
        - --noinput
      volumeMounts:
        - name: static
          mountPath: /code/static

  additionalInitContainers: []

  # will add init containers which change permissions for TLS certs and mounts certs to the target container
  enabledInitContainersCertificate:
    enabled: "{{ .Values.tls.enabled }}"
    mountToContainer: daphne
    userCertsOwner: www-data:www-data


# ------- Additional containers -------
  daphne:
    resources:
      limits:
        cpu: 1
        memory: 512Mi
      requests:
        cpu: 0
        memory: 256Mi
        ephemeral-storage: 10Gi
      volumeMounts:
        - name: localcache
          mountPath: /tmp/gravyvaletlocalcache
        #### If Enabled persistence < ----------
        # - name: data
        #   mountPath: /var/lib/gravyvaletlocaldata/

  sidecars: [] # same as additionalContainers, but maybe you prefer this name more :)

  additionalContainers:
    - name: daphne
      inheritVolumeMountsFrom: daphne # <----- gets volume mounts from daphne set of vars above
      image: "{{ .Values.appImage.repository }}:{{ .Values.appImage.tag }}"
      imagePullPolicy: "{{ .Values.appImage.pullPolicy }}"
      command:
        - /bin/sh
        - -c
        - "python -m daphne -b 0.0.0.0 -p {{ .Values.main.http.containers.nginx.externalPort }} app.asgi:application"
      env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
      envFrom:
        - configMapRef:
            name: '{{ include "cos-common.fullname" (dict "root" . "name" "common-env") | trim }}'
        - secretRef:
            name: '{{ include "cos-common.fullname" (dict "root" . "name" "common-env") | trim }}'
        - configMapRef:
            name: '{{ include "cos-common.fullname" (dict "root" . "name" "daphne-env") | trim }}'
      ports:
        - name: http-external
          containerPort: "{{ .Values.main.http.containers.nginx.externalPort }}"
      readinessProbe:
        httpGet:
          path: /v1/status/
          port: "{{ .Values.main.http.containers.nginx.externalPort }}"
      resources:
        limits:
          cpu: "{{ .Values.main.daphne.resources.limits.cpu }}"
          memory: "{{ .Values.main.daphne.resources.limits.memory }}"
        requests:
          cpu: "{{ .Values.main.daphne.resources.requests.cpu }}"
          memory: "{{ .Values.main.daphne.resources.requests.memory }}"
          ephemeral-storage: "{{ index .Values.main.daphne.resources.requests \"ephemeral-storage\" }}"


# ------- Volumes configuration for the pod -------
  volumes:
    - name: config
      configMap:
        name: '{{ include "cos-common.fullname" (dict "root" . "name" "") | trim }}'
    - name: secret
      secret:
        secretName: '{{ include "cos-common.fullname" (dict "root" . "name" "") | trim }}'
    - name: static
      emptyDir: {}
    - name: localcache
      emptyDir: {}

  additionalVolumes:
    - name: data
      emptyDir: {}
    #### If Enabled persistence < ---------- 
    # -----> Option 1 to create persistent volume
    #
    # - name: data # PVC name will be: '{{ include "cos-common.fullname" (dict "root" . "name" "") | trim }}' + name
    #   persistence: 
    #     enabled: true 
    #     accessModes:
    #       - ReadWriteOnce
    #     size: 100Gi
    #     storageClass: ""
    #     existingClaim: ""

    # -----> Option 2 to create persistent volume
    #
    # - name: data
    #   persistentVolumeClaim:
    #     claimName: '{{ include "cos-common.fullname" (dict "root" . "name" "") | trim }}'

  # -----> Option 2 to create persistent volume
  #
  # PVC name will be '{{ include "cos-common.fullname" (dict "root" . "name" "") | trim }}'
  #
  # persistence: 
  #   enabled: true 
  #   accessModes:
  #     - ReadWriteOnce
  #   size: 100Gi
  #   storageClass: ""
  #   existingClaim: ""


  # ------- Affinity configuration -------
  affinity: {}
  #   podAntiAffinity:
  #     preferredDuringSchedulingIgnoredDuringExecution:
  #       - weight: 1
  #         podAffinityTerm:
  #           topologyKey: kubernetes.io/hostname
  #           labelSelector:
  #             matchLabels:
  #               app.kubernetes.io/name: "{{ .Chart.Name }}"
  #               app.kubernetes.io/instance: "{{ .Release.Name }}"
  #               app.kubernetes.io/component: "{{ .Chart.Name }}" # in this case component name = chart name, because we leave name in main.yaml empty.
  
  additionalAffinities: []
    # - nodeAffinity:
    #     requiredDuringSchedulingIgnoredDuringExecution:
    #       nodeSelectorTerms:
    #         - matchExpressions:
    #             - key: cloud.google.com/gke-preemptible
    #               operator: In
    #               values:
    #                 - "true"


# ------- Pod Annotations -------
  podAnnotations:
    checksum/config: "{{ sha256sum (tpl (toYaml .Values.main.configMap.data) . ) }}"
    checksum/secret: "{{ sha256sum (tpl (toYaml .Values.main.secret.data) . ) }}"

# ------- Service configuration -------
# service name: '{{ include "cos-common.fullname" (dict "root" . "name" "") | trim }}'
  service:
    enabled: true
    type: "{{ .Values.main.http.containers.nginx.serviceType }}"
    ports:
      - name: http
        port: "{{ .Values.main.http.containers.nginx.externalPort }}"
        targetPort: "{{ .Values.main.http.containers.nginx.internalPort }}"


# ------- Ingress configuration -------
# ingress name: '{{ include "cos-common.fullname" (dict "root" . "name" "") | trim }}'
  ingress:
    enabled: false
    annotations: {}
      # kubernetes.io/ingress.class: nginx
      # kubernetes.io/tls-acme: "true"
    hosts:
      primary:
        - chart-example.local
      # secondary:
      #   - chart-example-2.local
    rules:
      - name: main
        includeForPrimaryHost: true
        includeForSecondaryHost: false
        pathType: ImplementationSpecific
        service:
          name: '{{ include "cos-common.fullname" (dict "root" . "name" "") | trim }}'
          port: "{{ .Values.main.http.containers.nginx.externalPort }}"
        paths:
          - /
    tls: []
      # - secretName: secret_name
      #   hosts: 
      #     - chart-example.local


# ------- Certificate configuration ------- (if we want to create Certificate object)
# certificate name: '{{ include "cos-common.fullname" (dict "root" . "name" "cert") | trim }}'
  certificate:
    enabled: false
    # secretName: secret-with-cert # default secret name is certificate name
    issuerRef:
      name: letsencrypt-prod
      kind: ClusterIssuer
    commonName: example.org
    dnsNames:
      - example.org
    acmeConfig:
      http01:
        ingress: 'example'
      domains:
        - example.org
        - subdomain.example.org

  # additionalCertificates:
  # # certificate name: '{{ include "cos-common.fullname" (dict "root" . "name" "cert") | trim }}' + name
  #   - name: example-org-cert
  #     enabled: false
  #     secretName: secret-with-cert # default secret name is certificate name
  #     commonName: example.org
  #     dnsNames:
  #       - example.org
  #       - submdomain.example.org
  #     issuerRef:
  #       name: letsencrypt-prod
  #       kind: ClusterIssuer
  #     acmeConfig:
  #       http01: {}
  #         # ingress: ''
  #       domains:
  #         - example.org
  #         - subdomain.example.org


# ------- HPA configuration -------
  hpa:
    enabled: false
    minReplicas: "{{ .Values.main.replicas }}"
    maxReplicas: 3
    metrics:
      - type: Resource
        resource:
          name: cpu
          target:
            type: Utilization
            averageUtilization: 90
    behavior: {}


# ------- PDB configuration -------
  pdb:
    enabled: false
    minAvailable: 1


# ------- Network Policy configuration -------
  networkPolicy:
    enabled: false
    componentScoped: false # this network policy will be applied to all components
    allowEgress: true
    ingressRules:
      - from:
        - podSelector:
            matchLabels: 
              '{{ include "cos-common.fullname" (dict "root" . "name" "client") | trim }}': "true"
        ports:
          - port: "{{ .Values.main.http.containers.nginx.internalPort }}"
      - ports:
        - port: "{{ .Values.nginx.vts.internalPort }}"
    egressRules: 
      - {}

  additionalNetworkPolicies:
    - name: cert-solver
      enabled: false
      podSelector:
        matchExpressions:
          - key: acme.cert-manager.io/http01-solver
            operator: Exists
      ingressRules:
        - from: []


# ------- ConfigMap configuration -------
# configmap name: '{{ include "cos-common.fullname" (dict "root" . "name" "") | trim }}'
  configMap:
    enabled: true
    tpl: true
    data:
      nginx.conf: |
        {{ tpl (.Files.Get "files/nginx.conf") (dict "Values" .Values "root" .) }}
      robots.txt: |-
        {{ .Files.Get "files/robots.txt" }}

# configmap name: '{{ include "cos-common.fullname" (dict "root" . "name" "") | trim }}' + name
  additionalConfigMaps:
    - name: common-env
      enabled: true
      tpl: false
      data: {}
    - name: daphne-env
      enabled: true
      tpl: false
      data: {}
        #### If Enabled persistence < ----------
        # gravyvalet_FILESTORE_DIR: /var/lib/gravyvaletlocaldata/
        # Provide other envs for daphne


# ------- Secrets configuration -------
# secret name: '{{ include "cos-common.fullname" (dict "root" . "name" "") | trim }}'
  secret:
    enabled: true
    includeTls: "{{ .Values.tls.enabled }}" # will include certs from "tls" block in values
    data: {}

# secret name: '{{ include "cos-common.fullname" (dict "root" . "name" "") | trim }}' + name  
  additionalSecrets:
    - name: common-env
      enabled: true
      includeTls: false
      data: {}


# =============== WORKER Component ===============
worker:
  enabled: true

  replicas: 1

  component: worker

# ------- Configuration follows for containerName: "{{ .Values.worker.component }}" -------
  image:
    repository: "{{ .Values.appImage.repository }}"
    tag: "{{ .Values.appImage.tag }}"
    pullPolicy: "{{ .Values.appImage.pullPolicy }}"

  containerName: "{{ .Values.worker.component }}"

  concurrency: 5
  logLevel: INFO
  maxTasksPerChild: 5
  queues: ""

  command:
    - /bin/sh
    - -c
    - |-
      python -m celery --app app worker \
        --concurrency "{{ .Values.worker.concurrency }}" --loglevel "{{ .Values.worker.logLevel }}" \
        --hostname $POD_NAME --without-gossip -Ofair
        {{- if .Values.worker.maxTasksPerChild }} --max-tasks-per-child "{{ .Values.worker.maxTasksPerChild }}"{{- end }}
        {{- if .Values.worker.queues }} --queues "{{ .Values.worker.queues }}"{{- end }}

  env:
    - name: POD_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name

  envFrom:
    - configMapRef:
        name: '{{ include "cos-common.fullname" (dict "root" . "name" "common-env") | trim }}'
    - secretRef:
        name: '{{ include "cos-common.fullname" (dict "root" . "name" "common-env") | trim }}'
    - configMapRef:
        name: '{{ include "cos-common.fullname" (dict "root" . "name" "worker-env") | trim }}'
    - secretRef:
        name: '{{ include "cos-common.fullname" (dict "root" . "name" "worker-env") | trim }}'

  probes: {}

  volumeMounts: []

  additionalVolumeMounts: []

  resources: {}

# ------- Init containers -------

  initContainers: []

  additionalInitContainers: []

  # will add init containers which change permissions for TLS certs and mounts certs to the target container
  enabledInitContainersCertificate:
    enabled: "{{ .Values.tls.enabled }}"


# ------- Additional containers -------
  additionalContainers: []

  sidecars: [] # same as additionalContainers, but maybe you prefer this name more :)


# ------- Volumes configuration for the pod -------
  volumes: 
    - name: secret
      secret:
        secretName: '{{ include "cos-common.fullname" (dict "root" . "name" "") | trim }}'
    - name: config
      configMap:
        name: '{{ include "cos-common.fullname" (dict "root" . "name" "") | trim }}'


# ------- Affitnity configuration -------
  affinity: {}
    # podAntiAffinity:
    #   preferredDuringSchedulingIgnoredDuringExecution:
    #     - weight: 1
    #       podAffinityTerm:
    #         topologyKey: kubernetes.io/hostname
    #         labelSelector:
    #           matchLabels:
    #             app.kubernetes.io/name: "{{ .Chart.Name }}"
    #             app.kubernetes.io/instance: "{{ .Release.Name }}"
    #             app.kubernetes.io/component: "{{ .Values.worker.component }}"


# ------- Pod Annotations -------
  podAnnotations:
    checksum/config: "{{ sha256sum (tpl (toYaml .Values.main.configMap.data) . ) }}"
    checksum/secret: "{{ sha256sum (tpl (toYaml .Values.main.secret.data) . ) }}"


# ------- HPA configuration -------
  hpa:
    enabled: false
    minReplicas: "{{ .Values.worker.replicas }}"
    maxReplicas: 3
    metrics:
      - type: Resource
        resource:
          name: cpu
          target:
            type: Utilization
            averageUtilization: 90
    behavior: {}


# ------- PDB configuration -------
  pdb:
    enabled: false
    minAvailable: 1


# ------- ConfigMap configuration -------
# configMap name: '{{ include "cos-common.fullname" (dict "root" . "name" "worker") | trim }}'
  configMap:
    enabled: false

# configMap name: '{{ include "cos-common.fullname" (dict "root" . "name" "worker") | trim }}' + name
  additionalConfigMaps:
    - name: env
      enabled: true
      tpl: false
      data: {}


# ------- Secrets configuration -------
# secret name: '{{ include "cos-common.fullname" (dict "root" . "name" "worker") | trim }}'
  secret:
    enabled: true
    includeTls: "{{ .Values.tls.enabled }}"
    data: {}

# secret name: '{{ include "cos-common.fullname" (dict "root" . "name" "worker") | trim }}' + name
  additionalSecrets:
    - name: env
      enabled: true
      includeTls: false
      data: {}


# ------- Selectors and etc. -------

  nodeSelector: {}

  tolerations: []


# =============== BEAT Component ===============
beat:
  enabled: true

  replicas: 1

  component: beat

  strategy:
    type: Recreate

# ------- Configuration follows for containerName: "{{ .Values.beat.component }}" -------
  image:
    repository: "{{ .Values.appImage.repository }}"
    tag: "{{ .Values.appImage.tag }}"
    pullPolicy: "{{ .Values.appImage.pullPolicy }}"

  containerName: "{{ .Values.beat.component }}"

  command:
    - /bin/sh
    - -c
    - |-
      set -e
      SUFFIX=''
      if [ -f /beat/celerybeat-schedule ]; then
        SUFFIX='--schedule=/beat/celerybeat-schedule'
      fi
      python -m celery --app app beat -l debug --pidfile= $SUFFIX

  env:
    - name: DJANGO_SETTINGS_MODULE
      value: app.settings
    - name: LOG_PATH
      value: /log

  envFrom:
    - configMapRef:
        name: '{{ include "cos-common.fullname" (dict "root" . "name" "common-env") | trim }}'
    - secretRef:
        name: '{{ include "cos-common.fullname" (dict "root" . "name" "common-env") | trim }}'
    - configMapRef:
        name: '{{ include "cos-common.fullname" (dict "root" . "name" "beat-env") | trim }}'
    - secretRef:
        name: '{{ include "cos-common.fullname" (dict "root" . "name" "beat-env") | trim }}'

  probes: {}

  volumeMounts:
    - mountPath: /beat
      name: "{{ .Values.beat.component }}"
    - mountPath: /log
      name: log

  additionalVolumeMounts: []

  resources: {}

# ------- Init containers -------
  initContainers:
    - name: chown
      image: "{{ .Values.appImage.repository }}:{{ .Values.appImage.tag }}"
      imagePullPolicy: "{{ .Values.appImage.pullPolicy }}"
      command:
        - /bin/bash
        - -c
        - chown -R www-data:www-data /beat /log
      securityContext:
        runAsUser: 0
      volumeMounts:
        - mountPath: /beat
          name: "{{ .Values.beat.component }}"
        - mountPath: /log
          name: log

  additionalInitContainers: []

  # will add init containers which change permissions for TLS certs and mounts certs to the target container
  enabledInitContainersCertificate:
    enabled: "{{ .Values.tls.enabled }}"


# ------- Additional containers -------
  additionalContainers: []

  sidecars: [] # same as additionalContainers, but maybe you prefer this name more :)


# ------- Volumes configuration for the pod -------
  volumes:
    - name: log
      emptyDir: {}
    - name: secret
      secret:
        secretName: '{{ include "cos-common.fullname" (dict "root" . "name" "") | trim }}'
    - name: config
      configMap:
        name: '{{ include "cos-common.fullname" (dict "root" . "name" "") | trim }}'

  additionalVolumes:
    - name: "{{ .Values.beat.component }}"
      persistence:
        enabled: true
        accessModes: 
          - ReadWriteOnce
        size: 4Gi
        existingClaim: ""
        storageClass: ""


# ------- Affitnity configuration -------
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 1
          podAffinityTerm:
            topologyKey: kubernetes.io/hostname
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: "{{ .Chart.Name }}"
                app.kubernetes.io/instance: "{{ .Release.Name }}"
                app.kubernetes.io/component: "{{ .Values.beat.component }}"


# ------- Pod Annotations -------
  podAnnotations:
    checksum/config: "{{ sha256sum (tpl (toYaml .Values.main.configMap.data) . ) }}"
    checksum/secret: "{{ sha256sum (tpl (toYaml .Values.main.secret.data) . ) }}"


# ------- ConfigMap configuration -------
# configmap name: '{{ include "cos-common.fullname" (dict "root" . "name" "beat") | trim }}'
  configMap:
    enabled: false

# configmap name: '{{ include "cos-common.fullname" (dict "root" . "name" "beat") | trim }}' + name
  additionalConfigMaps:
    - name: env
      enabled: true
      tpl: false
      data: {}


# ------- Secrets configuration -------
# secret name: '{{ include "cos-common.fullname" (dict "root" . "name" "beat") | trim }}'
  secret:
    enabled: true
    includeTls: "{{ .Values.tls.enabled }}"
    data: {}

# secret name: '{{ include "cos-common.fullname" (dict "root" . "name" "beat") | trim }}' + name
  additionalSecrets:
    - name: env
      enabled: true
      includeTls: false
      data: {}


# ------- Selectors and etc. -------
  nodeSelector: {}

  tolerations: []


# =============== MIGRATION Component ===============
migration:
  enabled: true

  component: migration

# ------- Configuration follows for containerName: "{{ .Values.migration.component }}" -------
  image:
    repository: "{{ .Values.appImage.repository }}"
    tag: "{{ .Values.appImage.tag }}"
    pullPolicy: "{{ .Values.appImage.pullPolicy }}"
  
  containerName: "{{ .Values.migration.component }}"

  activeDeadlineSeconds: 900

  workloadAnnotations:
    "helm.sh/hook": post-install,post-upgrade

  restartPolicy: Never

  command:
    - /bin/sh
    - -c
    - python manage.py migrate

  env: []

  envFrom:
    - configMapRef:
        name: '{{ include "cos-common.fullname" (dict "root" . "name" "common-env") | trim }}'
    - secretRef:
        name: '{{ include "cos-common.fullname" (dict "root" . "name" "common-env") | trim }}'
    - configMapRef:
        name: '{{ include "cos-common.fullname" (dict "root" . "name" "migration-env") | trim }}'
    - secretRef:
        name: '{{ include "cos-common.fullname" (dict "root" . "name" "migration-env") | trim }}'

  volumeMounts: []

  additionalVolumeMounts: []


# ------- Init containers -------
  initContainers: []

  additionalInitContainers: []

  # will add init containers which change permissions for TLS certs and mounts certs to the target container
  enabledInitContainersCertificate:
    enabled: "{{ .Values.tls.enabled }}"


# ------- Volumes configuration for the pod -------
  volumes:
    - name: secret
      secret:
        secretName: '{{ include "cos-common.fullname" (dict "root" . "name" "") | trim }}'
    - name: config
      configMap:
        name: '{{ include "cos-common.fullname" (dict "root" . "name" "") | trim }}'


# ------- Pod Annotations -------
  podAnnotations:
    checksum/config: "{{ sha256sum (tpl (toYaml .Values.main.configMap.data) . ) }}"
    checksum/secret: "{{ sha256sum (tpl (toYaml .Values.main.secret.data) . ) }}"


# ------- ConfigMap configuration -------
# configMap name: '{{ include "cos-common.fullname" (dict "root" . "name" "migration") | trim }}'
  configMap:
    enabled: false

# configMap name: '{{ include "cos-common.fullname" (dict "root" . "name" "migration") | trim }}' + name
  additionalConfigMaps:
    - name: env
      enabled: true
      tpl: false
      data: {}


# ------- Secrets configuration -------
# secret name: '{{ include "cos-common.fullname" (dict "root" . "name" "migration") | trim }}'
  secret:
    enabled: true
    includeTls: "{{ .Values.tls.enabled }}"
    data: {}

# secret name: '{{ include "cos-common.fullname" (dict "root" . "name" "migration") | trim }}' + name
  additionalSecrets:
    - name: env
      enabled: true
      includeTls: false
      data: {}
