user nginx;
worker_processes 1;

load_module /usr/lib/nginx/modules/ngx_http_brotli_filter_module.so;
{{- if .Values.web.nginx.vts.enabled }}
load_module /usr/lib/nginx/modules/ngx_http_geoip_module.so;
load_module /usr/lib/nginx/modules/ngx_http_vhost_traffic_status_module.so;
{{- end }}
{{- if and .Values.web.nginx.cache.enabled .Values.redis.enabled }}
load_module /usr/lib/nginx/modules/ndk_http_module.so;
load_module /usr/lib/nginx/modules/ngx_http_echo_module.so;
load_module /usr/lib/nginx/modules/ngx_http_redis_module.so;
load_module /usr/lib/nginx/modules/ngx_http_redis2_module.so;
load_module /usr/lib/nginx/modules/ngx_http_set_misc_module.so;
load_module /usr/lib/nginx/modules/ngx_http_srcache_filter_module.so;
{{- end }}
{{- range .Values.web.nginx.modules }}
load_module {{ . }};
{{- end }}

error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - {{ if and .Values.web.nginx.cache.enabled .Values.redis.enabled }}$srcache_fetch_status{{ else }}$upstream_cache_status{{ end }} $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct="$upstream_connect_time" uht="$upstream_header_time" urt="$upstream_response_time"';
    access_log /var/log/nginx/access.log main;

    real_ip_header {{ .Values.web.nginx.realIpHeader }};
    real_ip_recursive {{ .Values.web.nginx.realIpRecursive }};
    {{- range .Values.web.nginx.proxySourceRanges }}
    set_real_ip_from {{ . }};
    {{- end }}

    {{- if .Values.web.nginx.vts.enabled }}
    geoip_country       /etc/nginx/GeoIP.dat;
    geoip_city          /etc/nginx/GeoLiteCity.dat;
    geoip_proxy_recursive on;
    {{- range .Values.web.nginx.proxySourceRanges }}
    geoip_proxy {{ . }};
    {{- end }}

    vhost_traffic_status_zone shared:vhost_traffic_status:{{ .Values.web.nginx.vts.statusZoneSize }};
    vhost_traffic_status_filter_by_set_key {{ .Values.web.nginx.vts.defaultFilterKey }};
    {{- end }}

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 620s;
    types_hash_max_size 2048;
    server_tokens off;

    gzip on;
    gzip_disable "MSIE [1-6]\.(?!.*SV1)";
    gzip_comp_level 2;
    gzip_min_length 512;
    gzip_proxied any;
    gzip_vary on;
    gzip_types text/plain text/css image/svg+xml application/javascript application/x-javascript text/xml application/xml text/javascript application/json application/xml+rss application/vnd.api+json;

    brotli on;
    brotli_types text/plain text/css image/svg+xml application/javascript application/x-javascript text/xml application/xml text/javascript application/json application/xml+rss application/vnd.api+json;

    {{- if .Values.web.nginx.vts.enabled }}
    server {
        listen {{ .Values.web.nginx.vts.internalPort }};
        server_name _;

        location /healthz {
            access_log off;
            return 200;
        }

        location /nginx_status {
            vhost_traffic_status_display;
            vhost_traffic_status_display_format html;
        }
    }
    {{- end }}

    {{- if .Values.web.nginx.cache.enabled }}
    ##
    # Caching Settings
    ##

    # Pull cache-busting key out of query string
    map $args $args_first {
        default $args;
        ~^(?<first>.*?)&?_=\d+ $first;
    }
    map $args $args_rest {
        default "";
        ~^\?_=\d+&?(?<rest>.*)$ $rest;
        ~_=\d+(?<rest>.*)$ $rest;
    }

    map "$http_user_agent" $agent_not_cacheable {
        default "";
        "~*(haproxy monitoring|rackspace monitoring|varnish|prerender)" "1";
    }
    map "$cookie_{{ .Values.web.nginx.cache.cookieName }}$http_authorization$arg_view_only$arg_signature$arg_provider$arg_render$agent_not_cacheable" $not_cacheable {
        default 1;
        "" 0;
    }

    {{- if not .Values.redis.enabled }}
    uwsgi_cache_path /cache/uwsgi keys_zone=osf_uwsgi_cache:10m inactive=120m;
    uwsgi_temp_path /cache/uwsgi-temp;
    {{- end }}
    {{- end }}

    {{- if .Values.web.nginx.brandedSubdomains }}
    server {
        listen {{ .Values.web.service.internalPort }};
        server_name "~^(?<sub>({{ join "|" .Values.web.nginx.brandedSubdomains }}))\.{{ .Values.web.nginx.primaryDomain | replace "." "\\." }}$";

        if ($http_x_forwarded_proto = "http") {
            return 301 https://$host$request_uri;
        }

        location = /favicon.ico {
            alias /static/code/website/static/favicon.ico;
        }

        location = /robots.txt {
            alias /usr/share/nginx/html/robots.txt;
        }

        location / {
            {{- if .Values.prerender.enabled }}
            include /etc/nginx/prerender.conf;
            {{- end }}

            # # Mitigate HTTPoxy Vulnerability
            # # https://www.nginx.com/blog/mitigating-the-httpoxy-vulnerability-with-nginx/
            # proxy_set_header Proxy                  "";

            # proxy_redirect off;
            # proxy_buffering off;
            # proxy_pass http://{{ (index .Values "osf-web").service.name }}:{{ (index .Values "osf-web").service.externalPort }};
            if ($request_uri ~* "^/\w{5}(/.*)?/?$") {
              return 307 https://{{ .Values.web.nginx.primaryDomain }}$request_uri;
            }
            return 307 https://{{ .Values.web.nginx.primaryDomain }}/registries/$sub$request_uri;
        }

    }
    {{- end }}

    {{- if .Values.web.nginx.preprintDomainMap }}
    {{- range $key, $val := .Values.web.nginx.preprintDomainMap }}
    server {
        listen {{ $.Values.web.service.internalPort }};
        server_name {{ $key }};
        return 301 https://{{ $.Values.web.nginx.primaryDomain }}/preprints/{{ $val }}$request_uri;
    }
    {{- end }}
    {{- end }}

    {{- if .Values.web.nginx.institutionDomainMap }}
    {{- range $key, $val := .Values.web.nginx.institutionDomainMap }}
    server {
        listen {{ $.Values.web.service.internalPort }};
        server_name {{ $key }};
        return 301 https://{{ $.Values.web.nginx.primaryDomain }}/institutions/{{ $val }}$request_uri;
    }
    {{- end }}
    {{- end }}

    server {
        listen {{ .Values.web.service.internalPort }} default_server;
        server_name _;

        client_max_body_size 25M;
        keepalive_timeout 620s;

        root /static/code;

        if ($http_x_forwarded_proto = "http") {
            return 301 https://$host$request_uri;
        }

        location = /healthz {
            access_log off;
            return 200;
        }

        location = /robots.txt {
            alias /usr/share/nginx/html/robots.txt;
        }

        location = /favicon.ico {
            alias /static/code/website/static/favicon.ico;
        }

        location ~* ^/static/addons/(.*?)/(.*) {
            alias /static/code/addons/$1/static/$2;
        }

        location ~* ^/static/(.*) {
            alias /static/code/website/static/$1;
        }

        {{- if (index .Values.web.nginx "additionalConfig") }}
        {{- .Values.web.nginx.additionalConfig | nindent 10 }}
        {{- end }}

        include /etc/nginx/conf.d/*.conf;

        location ~* ^/share(/?$|/.*) {
            return 301 {{ .Values.share.url }};
        }

        {{- if and .Values.web.nginx.cache.enabled .Values.web.nginx.cache.guids }}
        location ~* (^/|^/api/v1/project/)({{ join "|" .Values.web.nginx.cache.guids }}) {
            {{- if .Values.prerender.enabled }}
            include /etc/nginx/prerender.conf;
            {{- end }}

            {{- if .Values.web.nginx.cache.enabled }}
            {{- if .Values.redis.enabled }}
            set $exp_time 3600; # Redis time in seconds
            include /etc/nginx/redis-cache.conf;
            {{- else }}
            uwsgi_cache_valid 200 60m;
            include /etc/nginx/uwsgi-cache.conf;
            {{- end }}
            {{- end }}

            # Disable caching of application requests
            add_header Cache-Control "no-cache, no-store, max-age=0, must-revalidate";
            add_header Expires "-1";
            add_header Pragma "no-cache";

            # Mitigate HTTPoxy Vulnerability
            # https://www.nginx.com/blog/mitigating-the-httpoxy-vulnerability-with-nginx/
            proxy_set_header Proxy                  "";

            # Pass requests to uwsgi application
            include /etc/nginx/uwsgi_params;
            # WARNING: Turning off uwsgi buffering will disable nginx caching.
            # uwsgi_buffering off;
            uwsgi_pass uwsgi://127.0.0.1:{{ .Values.web.service.externalPort }};
        }
        {{- end }}

        location / {
            {{- if .Values.prerender.enabled }}
            include /etc/nginx/prerender.conf;
            {{- end }}

            {{- if .Values.web.nginx.cache.enabled }}
            {{- if .Values.redis.enabled }}
            set $exp_time 60; # Redis time in seconds
            include /etc/nginx/redis-cache.conf;
            {{- else }}
            uwsgi_cache_valid 200 1m;
            include /etc/nginx/uwsgi-cache.conf;
            {{- end }}
            {{- end }}

            # Disable caching of application requests
            add_header Cache-Control "no-cache, no-store, max-age=0, must-revalidate";
            add_header Expires "-1";
            add_header Pragma "no-cache";

            # Mitigate HTTPoxy Vulnerability
            # https://www.nginx.com/blog/mitigating-the-httpoxy-vulnerability-with-nginx/
            proxy_set_header Proxy                  "";

            # Pass requests to uwsgi application
            include /etc/nginx/uwsgi_params;

            # Timeout for waiting on the response body
            uwsgi_read_timeout {{ .Values.web.nginx.readTimeout }}s;

            # WARNING: Turning off uwsgi buffering will disable nginx caching.
            # uwsgi_buffering off;
            uwsgi_pass uwsgi://127.0.0.1:{{ .Values.web.service.externalPort }};

            # URL rewrites
            rewrite "^/project/.*?/node/(.*)" https://$host/$1 permanent;
            rewrite "^/project/([a-zA-Z0-9]{5,}.*)" https://$host/$1 permanent;
            rewrite "^/profile/([a-zA-Z0-9]{5,})" https://$host/$1 permanent;
            {{- range .Values.web.nginx.additionalRewrites }}
            {{ . }}
            {{- end }}
        }
    }

    {{- if .Values.web.nginx.redirects.enabled }}
    # WARNING: Must remain at the bottom to ensure connections default to
    # the first server configuration for institutions
    {{- range $value := .Values.web.nginx.redirects.domains }}
    server {
        listen {{ $.Values.web.service.internalPort }};
        server_name {{ $value.from | join " " }};
        return 301 https://{{ $value.to }}$request_uri;
    }
    {{- end }}
    {{- end }}
}