[uwsgi]
uid = www-data
gid = www-data

# add user-agent, http://uwsgi.unbit.narkive.com/jEtphIzE/default-log-format-explained#post5
log-format = [pid: %(pid)|app: ?|req: ?/?] %(addr) (%(user)) {%(vars) vars in %(pktsize) bytes} [%(ctime)] %(method) %(uri) => generated %(rsize) bytes in %(msecs) msecs (%(proto) %(status)) %(headers) headers in %(hsize) bytes (%(switches) switches on core %(core)) "%(uagent)"

# Flask-related settings
chdir = /code
module = api.base.wsgi:application
env = OSF_PRODUCTION=1
env = DJANGO_SETTINGS_MODULE=api.base.settings
env = DEBUG=

# process-related settings
master = true
threads = 1
harakiri = 120
buffer-size = 8192
stats = :1717
vacuum = true
need-app = true
show-config = true
wsgi-disable-file-wrapper = {{ .Values.web.uwsgi.disableFileWrapper | default true }}

{{- if .Values.api.uwsgi.maxRequests }}
max-requests = {{ .Values.api.uwsgi.maxRequests }}
{{- end }}
{{- if .Values.api.uwsgi.maxRequestsDelta }}
max-requests-delta = {{ .Values.api.uwsgi.maxRequestsDelta }}
{{- end }}
{{- if .Values.web.uwsgi.maxWorkerLifetime }}
max-worker-lifetime = {{ .Values.web.uwsgi.maxWorkerLifetime }}
{{- end }}

{{- if .Values.api.uwsgi.cheaper.enabled }}
# Adaptive process spawning
# https://uwsgi-docs.readthedocs.io/en/latest/Cheaper.html
cheaper-algo = {{ .Values.api.uwsgi.cheaper.algo }}

# Min, initial, max workers
cheaper = {{ .Values.api.uwsgi.cheaper.minWorkerCount }}
cheaper-initial = {{ .Values.api.uwsgi.workerCount }}
workers = {{ .Values.api.uwsgi.cheaper.maxWorkerCount }}

cheaper-step = {{ .Values.api.uwsgi.cheaper.step }}

{{- if eq .Values.api.uwsgi.cheaper.algo "busyness" }}
# Required for algo "busyness" proper tuning
# Note: These defaults are experimental
# https://uwsgi-docs.readthedocs.io/en/latest/Cheaper.html#busyness-cheaper-algorithm
cheaper-overload = {{ .Values.api.uwsgi.cheaper.overload | default 20 }}
cheaper-busyness-min = {{ .Values.api.uwsgi.cheaper.busynessMin | default 30 }}
cheaper-busyness-max = {{ .Values.api.uwsgi.cheaper.busynessMax | default 75 }}
cheaper-busyness-multiplier = {{ .Values.api.uwsgi.cheaper.busynessMult | default 20 }}
cheaper-busynes-penalty = {{ .Values.api.uwsgi.cheaper.busynessPenalty | default 5 }}
cheaper-busyness-verbose = {{ .Values.api.uwsgi.cheaper.busynessVerbose | default true }}
cheaper-busyness-backlog-alert = {{ .Values.api.uwsgi.cheaper.busynessBacklogAlert | default 15 }}
cheaper-busyness-backlog-multiplier = {{ .Values.api.uwsgi.cheaper.busynessBacklogMultiplier | default 3 }}
cheaper-busyness-backlog-step = {{ .Values.api.uwsgi.cheaper.busynessBacklogStep | default 2 }}
cheaper-busyness-backlog-nonzero = {{ .Values.api.uwsgi.cheaper.busynessBacklogNonzero | default 10 }}
{{- end}}

{{- else }}
workers = {{ .Values.api.uwsgi.workerCount }}
{{- end}}

# greenlet settings
gevent = 500
gevent-early-monkey-patch = true