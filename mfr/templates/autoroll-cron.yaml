{{- if .Values.autoroll.enabled -}}
{{- $base := include "cos-common.fullname" (dict "root" . "name" .Values.autoroll.name) | trim -}}
{{- $serviceAccount := printf "%s-deleter" $base -}}
{{- $role := printf "%s-role" $base -}}
{{- $roleBinding := printf "%s-rolebinding" $base -}}
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ $role }}
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["list", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ $roleBinding }}
subjects:
  - kind: ServiceAccount
    name: {{ $serviceAccount }}
    namespace: {{ .Release.Namespace }}
roleRef:
  kind: ClusterRole
  name: {{ $role }}
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ $serviceAccount }}
  namespace: {{ .Release.Namespace }}
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ $base }}
  labels:
    {{- include "cos-common.labels" (dict "root" . "name" .Values.autoroll.name "values" dict) | nindent 4 }}
spec:
  schedule: {{ default "0 4 * * *" .Values.autoroll.schedule | quote }}
  startingDeadlineSeconds: {{ default 900 .Values.autoroll.startingDeadlineSeconds }}
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      activeDeadlineSeconds: {{ default 14400 .Values.autoroll.activeDeadlineSeconds }}
      template:
        metadata:
          labels:
            {{- include "cos-common.podLabels" (dict "root" . "name" .Values.autoroll.name) | nindent 12 }}
        spec:
          serviceAccountName: {{ $serviceAccount }}
          restartPolicy: Never
          containers:
            - name: {{ .Values.autoroll.name }}
              image: "{{ .Values.autoroll.image.repository }}:{{ .Values.autoroll.image.tag }}"
              imagePullPolicy: {{ .Values.autoroll.image.pullPolicy }}
              command:
                - kubectl
              args:
                - delete
                - pod
                - -l
                - app.kubernetes.io/name={{ include "cos-common.chartName" (dict "root" .) }},app.kubernetes.io/instance={{ .Release.Name }},app.kubernetes.io/component={{ include "cos-common.componentName" (dict "root" . "name" "") }}
          nodeSelector:
            {{- toYaml .Values.autoroll.nodeSelector | nindent 12 }}
{{- end -}}
